---
title: "DSII_homework2"
author: "Chirag Shah"
date: '2019-03-19'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(caret)
library(glmnet)
library(splines)
library(ISLR)
library(boot)
library(mgcv)
```

Data Import 

```{r}
concrete = read_csv("concrete.csv") %>%
  janitor::clean_names()
```

#Part A

```{r, fig.height=5}
# matrix of predictors 
x <- model.matrix(compressive_strength~.,concrete)[,-1]
# vector of response
y <- concrete$compressive_strength
theme1 <- trellis.par.get()
theme1$plot.symbol$col <- rgb(.2, .4, .2, .5)
theme1$plot.symbol$pch <- 16
theme1$plot.line$col <- rgb(.8, .1, .1, 1)
theme1$plot.line$lwd <- 2
theme1$strip.background$col <- rgb(.0, .2, .6, .2)
trellis.par.set(theme1)
featurePlot(x, y, plot = "scatter", labels = c("","compressive strength"),
            type = c("p"), layout = c(4, 2))
```

#Part B

```{r}
#polynomial regression
fit1 <- lm(compressive_strength~water, data = concrete)
fit2 <- lm(compressive_strength~poly(water,2), data = concrete) 
fit3 <- lm(compressive_strength~poly(water,3), data = concrete) 
fit4 <- lm(compressive_strength~poly(water,4), data = concrete) 
```

```{r}
#cross validation with K=10 to determine polynomial degree
ctrl1 <- trainControl(method = "cv", number = 10)

set.seed(1)

lmFit1 <- train(compressive_strength~water,
                data = concrete,
                method = "lm",
                trControl = ctrl1)
lmFit1

lmFit2 <- train(compressive_strength~water^2,
                data = concrete,
                method = "lm",
                trControl = ctrl1)
lmFit2

lmFit3 <- train(compressive_strength~water^3,
                data = concrete,
                method = "lm",
                trControl = ctrl1)
lmFit3

lmFit4 <- train(compressive_strength~water^4,
                data = concrete,
                method = "lm",
                trControl = ctrl1)
lmFit4
```

Comparing models using the resamples function

```{r}
resamp <- resamples(list(lm1 = lmFit1, lm2 = lmFit2, lm3 = lmFit3, lm4 = lmFit4))
summary(resamp)
```

```{r}
modelDifferences <- diff(resamp)
summary(modelDifferences)
```

The cross validation approach produced models with very similar RMSE values. While models with the exponent of 2 and 3 for water are the lowest they aren't by much. With that being said, the r squared value for the exponent 4 is the highest indicating that the differences in compressive_strength is more explained by water^4 than any other polynomial function. Therefore lets confirm using the anova test.

```{r}
anova(fit1,fit2,fit3,fit4) 

plot1 <- ggplot(data = concrete, aes(x = water, y = compressive_strength)) +
     geom_point(color = rgb(.2, .4, .2, .5))
plot1
plot(fit1) + 
plot(fit2) + 
plot(fit3) +
plot(fit4) 
```
Using the anova test, models with an exponent of 2, 3, and 4 are significant. However, lets use d=2 since we want the most parsimonious model. 

#Part C

```{r}
#Use cross validation to find degrees of freedom 
fit.ss <- smooth.spline(concrete$water, concrete$compressive_strength)
fit.ss$df

pred.smooth <- predict(fit.ss, x = water.grid)
pred.smooth.df <- data.frame(pred = pred.ss$y,
                         water = water.grid)

fitplot <- ggplot(data = concrete, aes(x = water, y = compressive_strength)) +
  geom_point(color = rgb(.2, .2, .4, .1)) + geom_line(aes(x = water, y = pred), data = pred.smooth.df, 
              color = rgb(.8, .1, .1, 1)) + theme_bw() 
fitplot
```

Here we will fit for different degrees of freedom for 2 to 10. 

```{r}
par(mfrow = c(3,3)) # 3 x 3 grid
all.dfs = rep(NA, 9)
for (i in 2:10) {
  fit.ss = smooth.spline(concrete_df$Water, concrete_df$CompressiveStrength, df = i)
  
  pred.ss <- predict(fit.ss, x = water.grid)
  
  plot(concrete_df$Water, concrete_df$CompressiveStrength, cex = .5, col = "darkgrey")
  title(paste("Degrees of freedom = ", round(fit.ss$df)),  outer = F)
  lines(water.grid, pred.ss$y, lwd = 2, col = "blue")
}
```

```{r}
#fit 1
fit.ss1 <- smooth.spline(concrete$water, concrete$compressive_strength, df = 58)
fit.ss1
pred.ss1 <- predict(fit.ss1, x = water.grid)
pred.ss.df1 <- data.frame(pred = pred.ss1$y, water = water.grid)
#fit 2
fit.ss2 <- smooth.spline(concrete$water, concrete$compressive_strength, df = 78)
fit.ss2
pred.ss2 <- predict(fit.ss2, x = water.grid)
pred.ss.df2 <- data.frame(pred = pred.ss2$y, water = water.grid)
#cv fit
fit.ss <- smooth.spline(concrete$water, concrete$compressive_strength)
fit.ss
pred.ss <- predict(fit.ss, x = water.grid)
pred.ss.df <- data.frame(pred = pred.ss$y, water = water.grid)
#plot of fits
smooth_fits <- plot1 + geom_line(aes(x = water, y = pred), data = pred.ss.df1,
          color = rgb(.8, .1, .1, 1)) + 
  geom_line(aes(x = water, y = pred), data = pred.ss.df2,
          color = rgb(0, 0, 1, 1)) + 
  geom_line(aes(x = water, y = pred), data = pred.ss.df3,
          color = rgb(1, 0, 1, 1)) + 
  geom_line(aes(x = water, y = pred), data = pred.ss.df,
          color = rgb(.2, .2, .4, 1)) + 
  theme_bw()
smooth_fits
```

#Part D

```{r}
gam.m1 <- gam(compressive_strength ~ cement + blast_furnace_slag + fly_ash + water + superplasticizer + coarse_aggregate + fine_aggregate + age, data = concrete)

gam.m2 <- gam(compressive_strength ~ cement + blast_furnace_slag + fly_ash + s(water) + superplasticizer + coarse_aggregate + fine_aggregate + age, data = concrete)

anova(gam.m1, gam.m2, test = "F")
```

```{r}
plot(gam.m2)

vis.gam(gam.m2, view = c("water", "fine_aggregate"), 
        plot.type = "contour", color = "topo")
vis.gam(gam.m2, view = c("water","coarse_aggregate"),
        plot.type = "contour", color = "topo")
```
